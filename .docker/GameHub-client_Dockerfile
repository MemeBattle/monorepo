FROM node:18.14-bullseye-slim AS dependencies

WORKDIR /memebattle

COPY .yarn/ /memebattle/.yarn
COPY package.json yarn.lock .yarnrc.yml /memebattle/
COPY packages/ui/package.json /memebattle/packages/ui/
COPY apps/gamehub-client/package.json /memebattle/apps/gamehub-client/

RUN yarn install

FROM dependencies AS build

ENV NODE_ENV=production

COPY . /memebattle
WORKDIR /memebattle

RUN node apps/gamehub-client/node_modules/.bin/next build apps/gamehub-client/

RUN rm -rf /memebattle/apps/gamehub-client/.next/cache

FROM dependencies AS prod-dependencies
ENV NODE_ENV=production

RUN yarn workspaces focus --production @memebattle/gamehub-client

FROM node:18.14-bullseye-slim AS runtime
ENV NODE_ENV=production

RUN mkdir -p /memebattle
WORKDIR /memebattle
USER node

COPY --chown=node:node --from=prod-dependencies /memebattle/node_modules ./node_modules
COPY --chown=node:node --from=build /memebattle/apps/gamehub-client/next.config.js ./apps/gamehub-client/gamehub-client
COPY --chown=node:node --from=build /memebattle/apps/gamehub-client/.next ./apps/gamehub-client/.next

ENTRYPOINT [ "./node_modules/.bin/next", "start", "apps/gamehub-client" ]
