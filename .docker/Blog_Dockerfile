FROM node:24.11-trixie-slim AS dependencies
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /memebattle

COPY package.json pnpm-lock.yaml .npmrc pnpm-workspace.yaml /memebattle/
COPY apps/blog/package.json /memebattle/apps/blog/

RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

FROM dependencies AS build

ENV NODE_ENV=production

COPY . /memebattle
WORKDIR /memebattle/apps/blog

RUN pnpm next build

FROM node:24.11-trixie-slim AS runtime
ENV NODE_ENV=production

RUN mkdir -p /memebattle
WORKDIR /memebattle
USER node

COPY --chown=node:node --from=build /memebattle/apps/blog/public ./apps/blog/public
COPY --chown=node:node --from=build /memebattle/apps/blog/.next/standalone ./
COPY --chown=node:node --from=build /memebattle/apps/blog/.next/static ./apps/blog/.next/static

ENTRYPOINT [ "node", "apps/blog/server.js" ]
