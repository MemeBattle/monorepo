FROM node:24.11-trixie-slim AS dependencies
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /memebattle

COPY package.json pnpm-lock.yaml .npmrc pnpm-workspace.yaml /memebattle/
COPY packages/ligretto-shared/package.json /memebattle/packages/ligretto-shared/
COPY packages/cas-services/package.json /memebattle/packages/cas-services/
COPY apps/ligretto-gameplay-backend/package.json /memebattle/apps/ligretto-gameplay-backend/

RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

FROM dependencies AS build

ENV NODE_ENV=production

COPY packages/ligretto-shared/ /memebattle/packages/ligretto-shared/
RUN pnpm run ligretto-shared:build

COPY apps/ligretto-gameplay-backend/ /memebattle/apps/ligretto-gameplay-backend/
RUN pnpm run ligretto:gameplay-backend:build

RUN pnpm deploy --prod --filter=@memebattle/ligretto-gameplay-backend /prod

FROM node:24.11-trixie-slim AS runtime
ENV NODE_ENV=production

USER node

COPY --chown=node:node --from=build /prod /ligretto-gameplay-backend
WORKDIR /ligretto-gameplay-backend

ENTRYPOINT [ "node", "build/index.js" ]
