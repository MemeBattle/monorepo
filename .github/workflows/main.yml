name: 'Build, push and deploy docker images'

on:
  push:
    branches: [ master ]

jobs:

  prepare-common:

    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install node
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install yarn
      run: npm install --global yarn

    - name: Auth npm
      run: |
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.CI_REGISTRY_TOKEN }}" >> .npmrc
        echo "@memebattle:registry=https://npm.pkg.github.com" >> .npmrc

    - name: Cache node modules
      uses: actions/cache@v2
      with:
        path: |
          node_modules
          ./apps/*/node_modules
          ./packages/*/node_modules
        key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}

    - name: Install dependecies
      run: yarn

    - name: Build common-packages
      run: yarn run common-packages:build

    - name: Upload common packages
      uses: actions/upload-artifact@v2
      with:
        name: packages-builds
        path: |
          packages/*/dist
          packages/*/build
          apps/auth-front/dist


  ligretto-frontend-image:

    needs: prepare-common

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2

    - name: Install node
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install yarn
      run: npm install --global yarn

    - name: Cache node modules
      uses: actions/cache@v2
      with:
        path: |
          node_modules
          ./apps/*/node_modules
          ./packages/*/node_modules
        key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}

    - name: Install dependecies
      run: yarn

    - name: Download common packages
      uses: actions/download-artifact@v2
      with:
        name: packages-builds

    - name: Build frontend
      run: yarn run ligretto:front:build

    - name: Docker login
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v2
      with:
        username: themezv
        password: ${{ secrets.CI_REGISTRY_TOKEN }}
        registry: ghcr.io
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/memebattle/ligretto-frontend:${{github.sha}}
          ghcr.io/memebattle/ligretto-frontend:latest
        context: './apps/ligretto-recovery'

  ligretto-backend-image:

    needs: prepare-common

    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2

      - name: Install node
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install yarn
        run: npm install --global yarn

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            ./apps/*/node_modules
            ./packages/*/node_modules
          key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}

      - name: Install dependecies
        run: yarn

      - name: Download common packages
        uses: actions/download-artifact@v2
        with:
          name: packages-builds

      - name: Build backend
        run: yarn run ligretto:back:build

      - name: Docker login
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          username: themezv
          password: ${{ secrets.CI_REGISTRY_TOKEN }}
          registry: ghcr.io
          platforms: linux/arm64
          push: true
          tags: |
            ghcr.io/memebattle/ligretto-backend:${{ github.sha }}
            ghcr.io/memebattle/ligretto-backend:latest
          context: './apps/ligretto-backend'

  ligretto-ui-image:

    needs: prepare-common

    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2

      - name: Install node
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install yarn
        run: npm install --global yarn

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: |
            node_modules
            ./apps/*/node_modules
            ./packages/*/node_modules
          key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}

      - name: Install dependecies
        run: yarn

      - name: Download common packages
        uses: actions/download-artifact@v2
        with:
          name: packages-builds

      - name: Build ligretto ui storybook
        run: yarn run ligretto:ui:build-storybook

      - name: Docker login
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          username: themezv
          password: ${{ secrets.CI_REGISTRY_TOKEN }}
          registry: ghcr.io
          platforms: linux/arm64
          push: true
          tags: |
            ghcr.io/memebattle/ligretto-ui:${{ github.sha }}
            ghcr.io/memebattle/ligretto-ui:latest
          context: './apps/ligretto-ui'

#  deploy:
#    needs: [ligretto-frontend-image, ligretto-ui-image, ligretto-backend-image]
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v2
#        name: Checkout
#      - name: Setup SSH
#        uses: kielabokkie/ssh-key-and-known-hosts-action@v1.1.0
#        with:
#          ssh-private-key: ${{ secrets.AWS_CI_PRIVATE_KEY }}
#          ssh-host: mems.fun
#
#      - name: create docker context
#        run: docker context create remote --docker "host=ssh://ci@mems.fun"
#
#      - name: deploy stack
#        run: |
#          docker context use remote
#          env $(cat .env | grep ^[A-Z] | xargs) docker stack deploy --with-registry-auth --prune -c docker-compose.deploy.yml Ligretto
